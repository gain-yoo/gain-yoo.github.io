---
layout: single
title: "[Database/DOIK] StatefulSet & Headless Service"
excerpt: "Database Operator In Kubernetes ìŠ¤í„°ë”” 1ì°¨ì‹œ - pod ìƒì„± ë° ë™ì‘ í™•ì¸_ì‘ì„±ì¤‘"
categories: Database
tag: [DOIK, Database Operator in Kubernetes, Database, ë°ì´í„°ë² ì´ìŠ¤, Kubernetes, ì¿ ë²„ë„¤í‹°ìŠ¤, DevOps, AWS, CloudFormation, StatefulSet, Headless Service, ìŠ¤í…Œì´íŠ¸í’€ì…‹, í—¤ë“œë¦¬ìŠ¤ì„œë¹„ìŠ¤]
toc: true
author_profile: false
sidebar:
    nav: "docs"
---
> í¬ìŠ¤íŒ… ìˆ˜ì • ì¤‘ ì…ë‹ˆë‹¤.

ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” StatefulSet & Headless Serviceë¥¼ ì‚¬ìš©í•˜ì—¬ podë¥¼ ìƒì„±í•´ ë³´ê³  ë™ì‘ ê³¼ì •ê¹Œì§€ í™•ì¸í•´ ë³¼ ê²ƒì´ë‹¤.

**Database**ë¥¼ **Kubernetes** í™˜ê²½ì—ì„œ **ìš´ì˜**í•˜ê¸° ìœ„í•´ì„œ <u>ë°˜ë“œì‹œ</u> í•„ìš”í•œ ê²ƒì€ ì•„ë˜ì™€ ê°™ë‹¤.
- íœ˜ë°œë˜ì§€ ì•Šì€ **ì˜êµ¬ ì €ì¥ì†Œ**
- ë™ì ìœ¼ë¡œ ë°”ë€ŒëŠ” podì˜ IP ì£¼ì†Œê°€ ì•„ë‹Œ **ê³ ì •ì ì¸ ì ‘ì† ì£¼ì†Œ**
- ë³´ì•ˆ ê°ì‚¬ ë§Œì¡±ì„ ìœ„í•œ **DB ì ‘ê·¼ í†µì œ**
- DB ìƒíƒœê°€ **ì •ìƒì¸ì§€** íŒë‹¨í•  ê¸°ì¤€

> ğŸ’¡ <u>ì˜êµ¬ ì €ì¥ì†Œ</u>, <u>ê³ ì •ì ì¸ ì ‘ì† ì£¼ì†Œ</u>ì˜ ì¡°ê±´ì„ ë§Œì¡±ì‹œí‚¤ëŠ” ê²ƒì´ **<u>StatefulSet</u>**ì´ë‹¤.

# ì‹¤ìŠµ 2. ìŠ¤í…Œì´íŠ¸í’€ì…‹ & í—¤ë“œë¦¬ìŠ¤ì„œë¹„ìŠ¤

1. pod ë°°í¬
    
    ```java
    (ğŸ |DOIK-Lab:default) root@k8s-m:~# curl -s -O https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/w                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚eb/web.yaml                                                                                                                                                                              â”‚CPU1   9.0%  â”‚ â”‚
    (ğŸ |DOIK-Lab:default) root@k8s-m:~# cat web.yaml
	                                                                                                                                        â”‚CPU2  10.0%  â”‚ â”‚
    	â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚       â”‚
    	 File: web.yaml                                                                                                                    â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â£€â ¤â ¤â ’â     â ˆ      â”‚
    	â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’â ’    â”‚
    	   1   â”‚ apiVersion: v1                                                                                                                                                                                  â”‚
    	   2   â”‚ kind: Service                                                                                                                                                                                   â”‚
    	   3   â”‚ metadata:                                                                                                                         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    	   4   â”‚   name: nginx                                                                                                                     oryâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 
    	   5   â”‚   labels:                                                                                                                                                 â¢¸â£¿â 33%â¢¹â£¿                             â”‚ 
    	   6   â”‚     app: nginx                                                                                                                                            â ˜â¢¿â£§â£„â£€â£¤â£¿â Ÿ                             â”‚ 
    	   7   â”‚ spec:                                                                                                                                                                                          â”‚ 
    	   8   â”‚   ports:                                                                                                                          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 
    	   9   â”‚   - port: 80                                                                                                                      pâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 
    	  10   â”‚     name: web                                                                                                                                             â¢¸â£¿â  0%â¢¹â£¿                             â”‚ 
    	  11   â”‚   clusterIP: None                                                                                                                                         â ˜â¢¿â£§â£„â£€â£¤â£¿â Ÿ                             â”‚ 
    	  12   â”‚   selector:                                                                                                                                                                                    â”‚ 
    	  13   â”‚     app: nginx                                                                                                                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 
    	  14   â”‚ ---
    	  15   â”‚ apiVersion: apps/v1                                                                                                               â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    	  16   â”‚ kind: StatefulSet                                                                                                                  %MEM                                                         â”‚
    	  17   â”‚ metadata:                                                                                                                                                                                       â”‚
    	  18   â”‚   name: web                                                                                                                         0.3                                                         â”‚
    	  19   â”‚ spec:                                                                                                                               0.0                                                         â”‚
    	  20   â”‚   serviceName: "nginx"                                                                                                              0.0                                                         â”‚
    	  21   â”‚   replicas: 2
    	  22   â”‚   selector:
    	  23   â”‚     matchLabels:
    	  24   â”‚       app: nginx
    	  25   â”‚   template:
    	  26   â”‚     metadata:
    	  27   â”‚       labels:
    	  28   â”‚         app: nginx
    	  29   â”‚     spec:
    	  30   â”‚       containers:
    	  31   â”‚       - name: nginx
    	  32   â”‚         image: k8s.gcr.io/nginx-slim:0.8
    	  33   â”‚         ports:
    	  34   â”‚         - containerPort: 80
    	  35   â”‚           name: web
    	  36   â”‚         volumeMounts:
    	  37   â”‚         - name: www
    	  38   â”‚           mountPath: /usr/share/nginx/html
    	  39   â”‚   volumeClaimTemplates:
    	  40   â”‚   - metadata:
    	  41   â”‚       name: www
    	  42   â”‚     spec:
    	  43   â”‚       accessModes: [ "ReadWriteOnce" ]
    	  44   â”‚       resources:
    	  45   â”‚         requests:
    	  46   â”‚           storage: 1Gi
    	  47   â”‚
    	â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (ğŸ |DOIK-Lab:default) root@k8s-m:~# kubectl apply -f web.yaml && kubectl get pods -w -l app=nginx
    	service/nginx created
    	statefulset.apps/web created
    	NAME    READY   STATUS    RESTARTS   AGE
    	web-0   0/1     Pending   0          0s
    	web-0   0/1     Pending   0          9s
    	web-0   0/1     ContainerCreating   0          9s
    	web-0   0/1     ContainerCreating   0          9s
    	web-0   1/1     Running             0          18s
    	web-1   0/1     Pending             0          0s
    	web-1   0/1     Pending             0          10s
    	web-1   0/1     ContainerCreating   0          10s
    	web-1   0/1     ContainerCreating   0          11s
    	web-1   1/1     Running             0          20s
    (ğŸ |DOIK-Lab:default) root@k8s-m:~# for i in 0 1; do kubectl exec "web-$i" -- sh -c 'hostname'; done
    	web-0
    	web-1
    ```
    
    - ë‹¤ë¥¸ í„°ë¯¸ë„ë¡œ ëª¨ë‹ˆí„°ë§
        
        ![Untitled](StatefulSet%20&%20Headless%20Service_%E1%84%8C%E1%85%A1%E1%86%A8%E1%84%89%E1%85%A5%E1%86%BC%E1%84%8C%E1%85%AE%E1%86%BC%209349dfc8cad1499eaca1445ba79823d3/Untitled%202.png)
        
2. netshoot ì´ë¯¸ì§€ë¡œ netdebug íŒŒë“œì— zsh ì‹¤í–‰
    
    ```java
    (ğŸ |DOIK-Lab:default) root@k8s-m:~# kubectl run -it --rm netdebug --image=nicolaka/netshoot --restart=Never -- zsh
    
    	If you don't see a command prompt, try pressing enter.
    	
    	                    dP            dP                           dP
    	                    88            88                           88
    	88d888b. .d8888b. d8888P .d8888b. 88d888b. .d8888b. .d8888b. d8888P
    	88'  `88 88ooood8   88   Y8ooooo. 88'  `88 88'  `88 88'  `88   88
    	88    88 88.  ...   88         88 88    88 88.  .88 88.  .88   88
    	dP    dP `88888P'   dP   `88888P' dP    dP `88888P' `88888P'   dP
    	
    	Welcome to Netshoot! (github.com/nicolaka/netshoot)
    	
    	
    
    	 netdebug î‚° ~ î‚° nslookup nginx
    		Server:         10.200.1.10
    		Address:        10.200.1.10#53
    		
    		Name:   nginx.default.svc.cluster.local
    		Address: 172.16.24.2
    		Name:   nginx.default.svc.cluster.local
    		Address: 172.16.158.2
    	
    	
    	 netdebug î‚° ~ î‚° nslookup -type=srv nginx     
    		Server:         10.200.1.10
    		Address:        10.200.1.10#53
    		
    		nginx.default.svc.cluster.local service = 0 50 80 web-0.nginx.default.svc.cluster.local.
    		nginx.default.svc.cluster.local service = 0 50 80 web-1.nginx.default.svc.cluster.local.
    		
    	
    	 netdebug î‚° ~ î‚° nslookup web-0.nginx
    		Server:         10.200.1.10
    		Address:        10.200.1.10#53
    		
    		Name:   web-0.nginx.default.svc.cluster.local
    		Address: 172.16.158.2
    	
    	
    	 netdebug î‚° ~ î‚° nslookup web-1.nginx
    		Server:         10.200.1.10
    		Address:        10.200.1.10#53
    		
    		Name:   web-1.nginx.default.svc.cluster.local
    		Address: 172.16.24.2
    		
    	
    	 netdebug î‚° ~ î‚° exit
    		pod "netdebug" deleted
    ```
    
3. íŒŒë“œ ì‚­ì œ ì‹¤í–‰ í›„ ì¬ì‹¤í–‰ ì‹œ ìƒì„± ìˆœì„œ í™•ì¸
    
    ```java
    (ğŸ |DOIK-Lab:default) root@k8s-m:~# kubectl delete pod -l app=nginx && kubectl get pods -w -l app=nginx
    		pod "web-0" deleted
    		pod "web-1" deleted
    		NAME    READY   STATUS              RESTARTS   AGE
    		web-0   0/1     ContainerCreating   0          1s
    		web-0   1/1     Running             0          2s
    		web-1   0/1     Pending             0          0s
    		web-1   0/1     Pending             0          0s
    		web-1   0/1     ContainerCreating   0          0s
    		web-1   0/1     ContainerCreating   0          1s
    		web-1   1/1     Running             0          2s
    (ğŸ |DOIK-Lab:default) root@k8s-m:~# for i in 0 1; do kubectl exec web-$i -- sh -c 'hostname'; done
    	web-0
    	web-1
    (ğŸ |DOIK-Lab:default) root@k8s-m:~# kubectl run -it --rm netdebug --image=nicolaka/netshoot --restart=Never -- zsh
    	If you don't see a command prompt, try pressing enter.
    	                    dP            dP                           dP   
    	                    88            88                           88
    	88d888b. .d8888b. d8888P .d8888b. 88d888b. .d8888b. .d8888b. d8888P
    	88'  `88 88ooood8   88   Y8ooooo. 88'  `88 88'  `88 88'  `88   88
    	88    88 88.  ...   88         88 88    88 88.  .88 88.  .88   88
    	dP    dP `88888P'   dP   `88888P' dP    dP `88888P' `88888P'   dP
    	
    	Welcome to Netshoot! (github.com/nicolaka/netshoot)
    	
    	
    	
    	 netdebug î‚° ~ î‚° nslookup nginx
    		Server:         10.200.1.10
    		Address:        10.200.1.10#53
    	
    		Name:   nginx.default.svc.cluster.local
    		Address: 172.16.24.4
    		Name:   nginx.default.svc.cluster.local
    		Address: 172.16.158.3
    	
    	
    	 netdebug î‚° ~ î‚° nslookup -type=srv nginx
    		Server:         10.200.1.10
    		Address:        10.200.1.10#53
    		
    		nginx.default.svc.cluster.local service = 0 50 80 web-0.nginx.default.svc.cluster.local.
    		nginx.default.svc.cluster.local service = 0 50 80 web-1.nginx.default.svc.cluster.local.
    		
    	
    	 netdebug î‚° ~ î‚° nslookup web-0.nginx
    		Server:         10.200.1.10
    		Address:        10.200.1.10#53
    		
    		Name:   web-0.nginx.default.svc.cluster.local
    		Address: 172.16.158.3
    	
    	
    	 netdebug î‚° ~ î‚° nslookup web-1.nginx
    		Server:         10.200.1.10
    		Address:        10.200.1.10#53
    	
    	Name:   web-1.nginx.default.svc.cluster.local
    		Address: 172.16.24.4
    	
    	
    	 netdebug î‚° ~ î‚° exit
    		pod "netdebug" deleted
    ```
    
4. pvc í™•ì¸
    
    ```java
    (ğŸ |DOIK-Lab:default) root@k8s-m:~# kubectl get pvc -l app=nginx
    	NAME        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
    	www-web-0   Bound    pvc-7cce446e-e68a-4783-99f9-fbb891538669   1Gi        RWO            local-path     11m
    	www-web-1   Bound    pvc-7defb95e-8b02-4886-851b-e339e234fd71   1Gi        RWO            local-path     11m
    ```
    
5. ì›¹ ì„œë²„ index.html ì— hostname ì¶”ê°€ í›„ ì›¹ ì ‘ì† í•´ì„œ í™•ì¸
    
    ```java
    (ğŸ |DOIK-Lab:default) root@k8s-m:~# for i in 0 1; do kubectl exec "web-$i" -- sh -c 'echo "$(hostname)-pv-test" > /usr/share/nginx/html/index.html'; done
    (ğŸ |DOIK-Lab:default) root@k8s-m:~# for i in 0 1; do kubectl exec -i -t "web-$i" -- curl http://localhost/; done
    	web-0-pv-test
    	web-1-pv-test
    ```
    
6. íŒŒë“œ ì‚­ì œ ì‹¤í–‰ í›„ ì¬ì‹¤í–‰ ì‹œ ìƒì„± ìˆœì„œ í™•ì¸
    
    ```java
    (ğŸ |DOIK-Lab:default) root@k8s-m:~# kubectl delete pod -l app=nginx && kubectl get pods -w -l app=nginx
    	pod "web-0" deleted
    	pod "web-1" deleted
    	NAME    READY   STATUS              RESTARTS   AGE
    	web-0   0/1     ContainerCreating   0          0s
    	web-0   0/1     ContainerCreating   0          1s
    	web-0   1/1     Running             0          2s
    	web-1   0/1     Pending             0          0s
    	web-1   0/1     Pending             0          0s
    	web-1   0/1     ContainerCreating   0          0s
    	web-1   0/1     ContainerCreating   0          1s
    	web-1   1/1     Running             0          2s
    ```
    
7. ì›¹ ì ‘ì† í•´ì„œ í™•ì¸ : PV ì €ì¥ì†Œ í™•ì¸
    
    ```java
    (ğŸ |DOIK-Lab:default) root@k8s-m:~# for i in 0 1; do kubectl exec -i -t "web-$i" -- curl http://localhost/; done
    	web-0-pv-test
    	web-1-pv-test
    ```
    
8. pod scale out & scale in
    
    ```java
    (ğŸ |DOIK-Lab:default) root@k8s-m:~# kubectl scale sts web --replicas=5 && kubectl get pods -w -l app=nginx
    	statefulset.apps/web scaled
    	NAME    READY   STATUS    RESTARTS   AGE
    	web-0   1/1     Running   0          88s
    	web-1   1/1     Running   0          86s
    	web-2   0/1     Pending   0          0s
    	web-2   0/1     Pending   0          10s
    	web-2   0/1     ContainerCreating   0          10s
    	web-2   0/1     ContainerCreating   0          11s
    	web-2   1/1     Running             0          18s
    //...ìƒëµ...
    (ğŸ |DOIK-Lab:default) root@k8s-m:~# kubectl patch sts web -p '{"spec":{"replicas":3}}' && kubectl get pods -w -l app=nginx
    	statefulset.apps/web patched
    	NAME    READY   STATUS        RESTARTS   AGE
    	web-0   1/1     Running       0          2m54s
    	web-1   1/1     Running       0          2m52s
    	web-2   1/1     Running       0          86s
    	web-3   1/1     Running       0          68s
    	web-4   1/1     Terminating   0          61s
    	web-4   1/1     Terminating   0          62s
    	web-4   0/1     Terminating   0          62s
    	web-4   0/1     Terminating   0          62s
    	web-4   0/1     Terminating   0          62s
    //...ìƒëµ...
    ```
    
9. ë¦¬ì†ŒìŠ¤ ì‚­ì œ
    
    ```java
    (ğŸ |DOIK-Lab:default) root@k8s-m:~# kubectl delete -f web.yaml && kubectl delete pvc --all
    	service "nginx" deleted
    	statefulset.apps "web" deleted
    	persistentvolumeclaim "www-web-0" deleted
    	persistentvolumeclaim "www-web-1" deleted
    	persistentvolumeclaim "www-web-2" deleted
    	persistentvolumeclaim "www-web-3" deleted
    	persistentvolumeclaim "www-web-4" deleted
    ```