---
layout: single
title: "[Database/DOIK] StatefulSet & Headless Service"
excerpt: "Database Operator In Kubernetes 스터디 1차시 - pod 생성 및 동작 확인_작성중"
categories: Database
tag: [DOIK, Database Operator in Kubernetes, Database, 데이터베이스, Kubernetes, 쿠버네티스, DevOps, AWS, CloudFormation, StatefulSet, Headless Service, 스테이트풀셋, 헤드리스서비스]
toc: true
author_profile: false
sidebar:
    nav: "docs"
---
> 포스팅 수정 중 입니다.

이번 포스팅에서는 StatefulSet & Headless Service를 사용하여 pod를 생성해 보고 동작 과정까지 확인해 볼 것이다.

**Database**를 **Kubernetes** 환경에서 **운영**하기 위해서 <u>반드시</u> 필요한 것은 아래와 같다.
- 휘발되지 않은 **영구 저장소**
- 동적으로 바뀌는 pod의 IP 주소가 아닌 **고정적인 접속 주소**
- 보안 감사 만족을 위한 **DB 접근 통제**
- DB 상태가 **정상인지** 판단할 기준

> 💡 <u>영구 저장소</u>, <u>고정적인 접속 주소</u>의 조건을 만족시키는 것이 **<u>StatefulSet</u>**이다.

# 실습 2. 스테이트풀셋 & 헤드리스서비스

1. pod 배포
    
    ```java
    (🍎 |DOIK-Lab:default) root@k8s-m:~# curl -s -O https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/application/w                                              ┌─────────────┐ │eb/web.yaml                                                                                                                                                                              │CPU1   9.0%  │ │
    (🍎 |DOIK-Lab:default) root@k8s-m:~# cat web.yaml
	                                                                                                                                        │CPU2  10.0%  │ │
    	───────┬───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────                                              └─────────────┘ │       │
    	 File: web.yaml                                                                                                                    ⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⣀⠤⠤⠒⠁    ⠈      │
    	───────┼───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒    │
    	   1   │ apiVersion: v1                                                                                                                                                                                  │
    	   2   │ kind: Service                                                                                                                                                                                   │
    	   3   │ metadata:                                                                                                                         ──────────────────────────────────────────────────────────────┘
    	   4   │   name: nginx                                                                                                                     ory──────────────────────────────────────────────────────────┐ 
    	   5   │   labels:                                                                                                                                                 ⢸⣿⠁33%⢹⣿                             │ 
    	   6   │     app: nginx                                                                                                                                            ⠘⢿⣧⣄⣀⣤⣿⠟                             │ 
    	   7   │ spec:                                                                                                                                                                                          │ 
    	   8   │   ports:                                                                                                                          ─────────────────────────────────────────────────────────────┘ 
    	   9   │   - port: 80                                                                                                                      p────────────────────────────────────────────────────────────┐ 
    	  10   │     name: web                                                                                                                                             ⢸⣿⠁ 0%⢹⣿                             │ 
    	  11   │   clusterIP: None                                                                                                                                         ⠘⢿⣧⣄⣀⣤⣿⠟                             │ 
    	  12   │   selector:                                                                                                                                                                                    │ 
    	  13   │     app: nginx                                                                                                                    ─────────────────────────────────────────────────────────────┘ 
    	  14   │ ---
    	  15   │ apiVersion: apps/v1                                                                                                               ──────────────────────────────────────────────────────────────┐
    	  16   │ kind: StatefulSet                                                                                                                  %MEM                                                         │
    	  17   │ metadata:                                                                                                                                                                                       │
    	  18   │   name: web                                                                                                                         0.3                                                         │
    	  19   │ spec:                                                                                                                               0.0                                                         │
    	  20   │   serviceName: "nginx"                                                                                                              0.0                                                         │
    	  21   │   replicas: 2
    	  22   │   selector:
    	  23   │     matchLabels:
    	  24   │       app: nginx
    	  25   │   template:
    	  26   │     metadata:
    	  27   │       labels:
    	  28   │         app: nginx
    	  29   │     spec:
    	  30   │       containers:
    	  31   │       - name: nginx
    	  32   │         image: k8s.gcr.io/nginx-slim:0.8
    	  33   │         ports:
    	  34   │         - containerPort: 80
    	  35   │           name: web
    	  36   │         volumeMounts:
    	  37   │         - name: www
    	  38   │           mountPath: /usr/share/nginx/html
    	  39   │   volumeClaimTemplates:
    	  40   │   - metadata:
    	  41   │       name: www
    	  42   │     spec:
    	  43   │       accessModes: [ "ReadWriteOnce" ]
    	  44   │       resources:
    	  45   │         requests:
    	  46   │           storage: 1Gi
    	  47   │
    	───────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
    (🍎 |DOIK-Lab:default) root@k8s-m:~# kubectl apply -f web.yaml && kubectl get pods -w -l app=nginx
    	service/nginx created
    	statefulset.apps/web created
    	NAME    READY   STATUS    RESTARTS   AGE
    	web-0   0/1     Pending   0          0s
    	web-0   0/1     Pending   0          9s
    	web-0   0/1     ContainerCreating   0          9s
    	web-0   0/1     ContainerCreating   0          9s
    	web-0   1/1     Running             0          18s
    	web-1   0/1     Pending             0          0s
    	web-1   0/1     Pending             0          10s
    	web-1   0/1     ContainerCreating   0          10s
    	web-1   0/1     ContainerCreating   0          11s
    	web-1   1/1     Running             0          20s
    (🍎 |DOIK-Lab:default) root@k8s-m:~# for i in 0 1; do kubectl exec "web-$i" -- sh -c 'hostname'; done
    	web-0
    	web-1
    ```
    
    - 다른 터미널로 모니터링
        
        ![Untitled](StatefulSet%20&%20Headless%20Service_%E1%84%8C%E1%85%A1%E1%86%A8%E1%84%89%E1%85%A5%E1%86%BC%E1%84%8C%E1%85%AE%E1%86%BC%209349dfc8cad1499eaca1445ba79823d3/Untitled%202.png)
        
2. netshoot 이미지로 netdebug 파드에 zsh 실행
    
    ```java
    (🍎 |DOIK-Lab:default) root@k8s-m:~# kubectl run -it --rm netdebug --image=nicolaka/netshoot --restart=Never -- zsh
    
    	If you don't see a command prompt, try pressing enter.
    	
    	                    dP            dP                           dP
    	                    88            88                           88
    	88d888b. .d8888b. d8888P .d8888b. 88d888b. .d8888b. .d8888b. d8888P
    	88'  `88 88ooood8   88   Y8ooooo. 88'  `88 88'  `88 88'  `88   88
    	88    88 88.  ...   88         88 88    88 88.  .88 88.  .88   88
    	dP    dP `88888P'   dP   `88888P' dP    dP `88888P' `88888P'   dP
    	
    	Welcome to Netshoot! (github.com/nicolaka/netshoot)
    	
    	
    
    	 netdebug  ~  nslookup nginx
    		Server:         10.200.1.10
    		Address:        10.200.1.10#53
    		
    		Name:   nginx.default.svc.cluster.local
    		Address: 172.16.24.2
    		Name:   nginx.default.svc.cluster.local
    		Address: 172.16.158.2
    	
    	
    	 netdebug  ~  nslookup -type=srv nginx     
    		Server:         10.200.1.10
    		Address:        10.200.1.10#53
    		
    		nginx.default.svc.cluster.local service = 0 50 80 web-0.nginx.default.svc.cluster.local.
    		nginx.default.svc.cluster.local service = 0 50 80 web-1.nginx.default.svc.cluster.local.
    		
    	
    	 netdebug  ~  nslookup web-0.nginx
    		Server:         10.200.1.10
    		Address:        10.200.1.10#53
    		
    		Name:   web-0.nginx.default.svc.cluster.local
    		Address: 172.16.158.2
    	
    	
    	 netdebug  ~  nslookup web-1.nginx
    		Server:         10.200.1.10
    		Address:        10.200.1.10#53
    		
    		Name:   web-1.nginx.default.svc.cluster.local
    		Address: 172.16.24.2
    		
    	
    	 netdebug  ~  exit
    		pod "netdebug" deleted
    ```
    
3. 파드 삭제 실행 후 재실행 시 생성 순서 확인
    
    ```java
    (🍎 |DOIK-Lab:default) root@k8s-m:~# kubectl delete pod -l app=nginx && kubectl get pods -w -l app=nginx
    		pod "web-0" deleted
    		pod "web-1" deleted
    		NAME    READY   STATUS              RESTARTS   AGE
    		web-0   0/1     ContainerCreating   0          1s
    		web-0   1/1     Running             0          2s
    		web-1   0/1     Pending             0          0s
    		web-1   0/1     Pending             0          0s
    		web-1   0/1     ContainerCreating   0          0s
    		web-1   0/1     ContainerCreating   0          1s
    		web-1   1/1     Running             0          2s
    (🍎 |DOIK-Lab:default) root@k8s-m:~# for i in 0 1; do kubectl exec web-$i -- sh -c 'hostname'; done
    	web-0
    	web-1
    (🍎 |DOIK-Lab:default) root@k8s-m:~# kubectl run -it --rm netdebug --image=nicolaka/netshoot --restart=Never -- zsh
    	If you don't see a command prompt, try pressing enter.
    	                    dP            dP                           dP   
    	                    88            88                           88
    	88d888b. .d8888b. d8888P .d8888b. 88d888b. .d8888b. .d8888b. d8888P
    	88'  `88 88ooood8   88   Y8ooooo. 88'  `88 88'  `88 88'  `88   88
    	88    88 88.  ...   88         88 88    88 88.  .88 88.  .88   88
    	dP    dP `88888P'   dP   `88888P' dP    dP `88888P' `88888P'   dP
    	
    	Welcome to Netshoot! (github.com/nicolaka/netshoot)
    	
    	
    	
    	 netdebug  ~  nslookup nginx
    		Server:         10.200.1.10
    		Address:        10.200.1.10#53
    	
    		Name:   nginx.default.svc.cluster.local
    		Address: 172.16.24.4
    		Name:   nginx.default.svc.cluster.local
    		Address: 172.16.158.3
    	
    	
    	 netdebug  ~  nslookup -type=srv nginx
    		Server:         10.200.1.10
    		Address:        10.200.1.10#53
    		
    		nginx.default.svc.cluster.local service = 0 50 80 web-0.nginx.default.svc.cluster.local.
    		nginx.default.svc.cluster.local service = 0 50 80 web-1.nginx.default.svc.cluster.local.
    		
    	
    	 netdebug  ~  nslookup web-0.nginx
    		Server:         10.200.1.10
    		Address:        10.200.1.10#53
    		
    		Name:   web-0.nginx.default.svc.cluster.local
    		Address: 172.16.158.3
    	
    	
    	 netdebug  ~  nslookup web-1.nginx
    		Server:         10.200.1.10
    		Address:        10.200.1.10#53
    	
    	Name:   web-1.nginx.default.svc.cluster.local
    		Address: 172.16.24.4
    	
    	
    	 netdebug  ~  exit
    		pod "netdebug" deleted
    ```
    
4. pvc 확인
    
    ```java
    (🍎 |DOIK-Lab:default) root@k8s-m:~# kubectl get pvc -l app=nginx
    	NAME        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
    	www-web-0   Bound    pvc-7cce446e-e68a-4783-99f9-fbb891538669   1Gi        RWO            local-path     11m
    	www-web-1   Bound    pvc-7defb95e-8b02-4886-851b-e339e234fd71   1Gi        RWO            local-path     11m
    ```
    
5. 웹 서버 index.html 에 hostname 추가 후 웹 접속 해서 확인
    
    ```java
    (🍎 |DOIK-Lab:default) root@k8s-m:~# for i in 0 1; do kubectl exec "web-$i" -- sh -c 'echo "$(hostname)-pv-test" > /usr/share/nginx/html/index.html'; done
    (🍎 |DOIK-Lab:default) root@k8s-m:~# for i in 0 1; do kubectl exec -i -t "web-$i" -- curl http://localhost/; done
    	web-0-pv-test
    	web-1-pv-test
    ```
    
6. 파드 삭제 실행 후 재실행 시 생성 순서 확인
    
    ```java
    (🍎 |DOIK-Lab:default) root@k8s-m:~# kubectl delete pod -l app=nginx && kubectl get pods -w -l app=nginx
    	pod "web-0" deleted
    	pod "web-1" deleted
    	NAME    READY   STATUS              RESTARTS   AGE
    	web-0   0/1     ContainerCreating   0          0s
    	web-0   0/1     ContainerCreating   0          1s
    	web-0   1/1     Running             0          2s
    	web-1   0/1     Pending             0          0s
    	web-1   0/1     Pending             0          0s
    	web-1   0/1     ContainerCreating   0          0s
    	web-1   0/1     ContainerCreating   0          1s
    	web-1   1/1     Running             0          2s
    ```
    
7. 웹 접속 해서 확인 : PV 저장소 확인
    
    ```java
    (🍎 |DOIK-Lab:default) root@k8s-m:~# for i in 0 1; do kubectl exec -i -t "web-$i" -- curl http://localhost/; done
    	web-0-pv-test
    	web-1-pv-test
    ```
    
8. pod scale out & scale in
    
    ```java
    (🍎 |DOIK-Lab:default) root@k8s-m:~# kubectl scale sts web --replicas=5 && kubectl get pods -w -l app=nginx
    	statefulset.apps/web scaled
    	NAME    READY   STATUS    RESTARTS   AGE
    	web-0   1/1     Running   0          88s
    	web-1   1/1     Running   0          86s
    	web-2   0/1     Pending   0          0s
    	web-2   0/1     Pending   0          10s
    	web-2   0/1     ContainerCreating   0          10s
    	web-2   0/1     ContainerCreating   0          11s
    	web-2   1/1     Running             0          18s
    //...생략...
    (🍎 |DOIK-Lab:default) root@k8s-m:~# kubectl patch sts web -p '{"spec":{"replicas":3}}' && kubectl get pods -w -l app=nginx
    	statefulset.apps/web patched
    	NAME    READY   STATUS        RESTARTS   AGE
    	web-0   1/1     Running       0          2m54s
    	web-1   1/1     Running       0          2m52s
    	web-2   1/1     Running       0          86s
    	web-3   1/1     Running       0          68s
    	web-4   1/1     Terminating   0          61s
    	web-4   1/1     Terminating   0          62s
    	web-4   0/1     Terminating   0          62s
    	web-4   0/1     Terminating   0          62s
    	web-4   0/1     Terminating   0          62s
    //...생략...
    ```
    
9. 리소스 삭제
    
    ```java
    (🍎 |DOIK-Lab:default) root@k8s-m:~# kubectl delete -f web.yaml && kubectl delete pvc --all
    	service "nginx" deleted
    	statefulset.apps "web" deleted
    	persistentvolumeclaim "www-web-0" deleted
    	persistentvolumeclaim "www-web-1" deleted
    	persistentvolumeclaim "www-web-2" deleted
    	persistentvolumeclaim "www-web-3" deleted
    	persistentvolumeclaim "www-web-4" deleted
    ```