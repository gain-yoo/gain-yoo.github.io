---
layout: single
title: "[Database/Kubernetes/DOIK] AWS EC2ì— Vanilla Kubernetes ì‹¤ìŠµ í™˜ê²½ ë°°í¬"
excerpt: "Database Operator In Kubernetes ìŠ¤í„°ë”” 0ì°¨ì‹œ"
categories: Database
tag: [DOIK, Database Operator in Kubernetes, Database, ë°ì´í„°ë² ì´ìŠ¤, Kubernetes, ì¿ ë²„ë„¤í‹°ìŠ¤, DevOps, AWS, CloudFormation, vanilla, ë°”ë‹ë¼ ì¿ ë²„ë„¤í‹°ìŠ¤, kubeadm, docker, calico]
toc: true
author_profile: false
sidebar:
    nav: "docs"
---

ì´ë²ˆì— **Database Operator In Kubernetes (DOIK)** ìŠ¤í„°ë””ì— ì°¸ì—¬í•˜ê²Œ ë˜ì—ˆë‹¤.  
ìŠ¤í„°ë””ì—ì„œ notionê³¼ slackìœ¼ë¡œ ê´€ë ¨ ìë£Œë¥¼ ê³µìœ í•´ ì£¼ì‹œëŠ”ë° ì¢‹ì€ ìë£Œê°€ ë§ì•„ì„œ í–‰ë³µí•˜ë‹¤,,ğŸ˜š
  
ì´ë²ˆì— ìƒˆë¡­ê²Œ ì•Œê²Œ ëœ ì‚¬ì‹¤ì€ ì°¨ë³„ ITìš©ì–´ê°€ ìˆì–´ì„œ ì§€ì–‘í•˜ëŠ” ë‹¨ì–´ê°€ ëª‡ ìˆë‹¤ëŠ” ê²ƒì´ë‹¤.  
ê·¸ ì¤‘ í•˜ë‚˜ëŠ” `Master Node`ì¸ë°, ì°¨ë³„ IT ìš©ì–´ë¡œ master slaveë¥¼ ë¹„ê¶Œì¥í•˜ë¯€ë¡œ Master Node ëŒ€ì‹  `Control Plane` ì‚¬ìš©ì„ ê¶Œì¥í•œë‹¤ê³  í•œë‹¤.  
ê·¸ë˜ì„œ ë‚˜ë„ ì´ì œë¶€í„° `Control Plane`ì´ë¼ê³  ì¹­í•  ê²ƒ ì´ë‹¤!  
  
---
ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” ìŠ¤í„°ë””ì—ì„œ ì œê³µí•´ ì¤€ CloudFormation í…œí”Œë¦¿ìœ¼ë¡œ EC2ì— **Vanilla Kubernetes**ë¥¼ ì„¤ì¹˜í•œ ê³¼ì •ì„ ë³´ì—¬ì¤„ ê²ƒì´ë‹¤.  
*`** Vanillaë€, í”„ë¡œê·¸ë¨ì— ì•„ë¬´ê²ƒë„ ì¶”ê°€í•˜ì§€ ì•Šì€ ìˆœì • ìƒíƒœì˜ ì†Œí”„íŠ¸ì›¨ì–´ë¥¼ ê°€ë¦¬í‚¤ëŠ” ì†ì–´ë‹¤.`*  

## 0. ì „ì²´ êµ¬ì„±ë„

![ì „ì²´êµ¬ì„±ë„](https://user-images.githubusercontent.com/100563973/170847784-839922b7-421c-4e7d-9b35-c08df81beb69.JPG)
  

- Kubernetes ë²„ì „ v1.23.6 , Calico CNI(CrossSubnet ëª¨ë“œ, ENI S/D Uncheck) , CRI(Docker), StorageClass(local-path, hostpath)
- EC2 Spec : Ubuntu 22.04, t3.medium, EBS gp3 40GiB
- ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ : Public Subnet 2ê°œ, Private Subnet 2ê°œ
- Control Plane 1ëŒ€, Worker Node 3ëŒ€ êµ¬ì„±

| Hostname | IPv4 |
| --- | --- |
| k8s-m | 192.168.10.10 |
| k8s-w1 | 192.168.10.101 |
| k8s-w2 | 192.168.10.102 |
| k8s-w3 | 192.168.20.103 |

## 1. Cloudfarmationìœ¼ë¡œ ìë™ ë°°í¬

### 0ë‹¨ê³„ : EC2 ì ‘ì†ì— ì‚¬ìš©í•˜ëŠ” SSH Key ìƒì„±

ì°¸ê³  ) [1ë‹¨ê³„: EC2 SSH í‚¤ í˜ì–´ ìƒì„±](https://docs.aws.amazon.com/ko_kr/ground-station/latest/ug/create-ec2-ssh-key-pair.html)

1. AWS Management Consoleì—ì„œ AWS ë¦¬ì „ ì„ íƒ : `ap-northeast-2 (ì„œìš¸)`
2. ì„œë¹„ìŠ¤ > EC2 > ë„¤íŠ¸ì›Œí¬ ë° ë³´ì•ˆ > í‚¤ í˜ì–´ > í‚¤ í˜ì–´ ìƒì„±
3. ì´ë¦„ : `doik-ec2-access-key-ap-northeast-2` / í‚¤ í˜ì–´ ìœ í˜• : `RSA` *(ê³µê°œí‚¤)* / í”„ë¼ì´ë¹— í‚¤ íŒŒì¼ í˜•ì‹ : `.pem` *(OpenSSHì™€ í•¨ê»˜ ì‚¬ìš©)* > í‚¤ í˜ì–´ ìƒì„±

### 1ë‹¨ê³„ : í…œí”Œë¦¿ ì§€ì •

- ìŠ¤í„°ë””ì—ì„œ ì œê³µí•´ ì¤€ í…œí”Œë¦¿
- Amazon S3 URL
- 
![Untitled 1](https://user-images.githubusercontent.com/100563973/170733549-25d06950-6052-4515-aa61-b95843e94e83.png)

### 2ë‹¨ê³„ : ìŠ¤íƒ ì„¸ë¶€ ì •ë³´ ì§€ì •

1. ìŠ¤íƒ ì´ë¦„ : `myk8s` *(ê¸°ë³¸)*
2. íŒŒë¼ë¯¸í„° :
    - <<<<< EC2 Node >>>>>
        - `KeyName` : 0ë‹¨ê³„ì—ì„œ ìƒì„±í•œ KeetPair ì„ íƒ
        - `SgIngressCidr` : EC2 ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì ‘ì†í•  ìˆ˜ ìˆëŠ” IP ì£¼ì†Œ ì…ë ¥ (`ë‚˜ì˜ public IP/32`)

### 3ë‹¨ê³„ : ìŠ¤íƒ ì˜µì…˜ êµ¬ì„±

- íŒ¨ìŠ¤

### 4ë‹¨ê³„ : ê²€í† 

- ë‚´ìš© í™•ì¸ > ìŠ¤íƒ ìƒì„±
    
    ![Untitled 2](https://user-images.githubusercontent.com/100563973/170733689-786d4c79-5569-45e2-a6e4-00eaab5bee8c.png)
    
- ì¸ìŠ¤í„´ìŠ¤ ìƒì„± í™•ì¸
    
    ![Untitled 3](https://user-images.githubusercontent.com/100563973/170733819-c39512ef-7cc7-4105-9a19-718c9698a6c5.png)
    
    ![Untitled 4](https://user-images.githubusercontent.com/100563973/170733832-23f4009c-1ef1-466f-95b7-ed8f535d6fab.png)
    
    

## 2. Cluster ìƒì„± ë° Component ì„¤ì¹˜

### (1) ì„¤ì¹˜ í›„, ê¸°ë³¸ setup

1. Control Plane ì ‘ì†
    - EC2ì—ì„œ ìƒì„±í•œ Private Keyë¡œ ssh ì ‘ì†
        
        ```java
        gain@LAPTOP-NGE5O25S:/mnt/c/Users/User/Downloads$ ssh -i ./myk8s.pem ubuntu@13.125.127.182
        	Welcome to Ubuntu 22.04 LTS (GNU/Linux 5.15.0-1005-aws x86_64)
        	
        	 * Documentation:  https://help.ubuntu.com
        	 * Management:     https://landscape.canonical.com
        	 * Support:        https://ubuntu.com/advantage
        	
        	  System information as of Fri May 27 18:20:23 KST 2022        
        	
        	  System load:  0.3359375         Processes:                143  Usage of /:   9.0% of 38.60GB   Users logged in:          0  
        	  Memory usage: 21%               IPv4 address for docker0: 172.17.0.1
        	  Swap usage:   0%                IPv4 address for ens5:    192.168.10.10
        	
        	
        	27 updates can be applied immediately.
        	21 of these updates are standard security updates.
        	                                                      able     
        	Last login: Fri May 27 16:07:30 2022 from 125.178.215.17
        (ğŸ¤ |kubernetes-admin@kubernetes:default) root@k8s-m:~#
        ```
        
    - ì²˜ìŒì—ëŠ” ì ‘ì† ì˜¤ë¥˜ë¥¼ ê²ªì—ˆë‹¤.. ì•„ë˜ í¬ìŠ¤íŒ… ì°¸ê³ 
        
        [[AWS] EC2 SSH ì ‘ì† ì—ëŸ¬](https://gain-yoo.github.io/trouble%20shooting/private-key-%EA%B6%8C%ED%95%9C-%EB%B3%80%EA%B2%BD/)
        
2. Control Plane ì„¤ì • ë¡œê·¸ í™•ì¸
    
    ```java
    (ğŸ |kubernetes-admin@kubernetes:default) root@k8s-m:~# sudo tail -f /var/log/cloud-init-output.log
    	No services need to be restarted.
    	
    	No containers need to be restarted.
    	
    	No user sessions are running outdated binaries.
    	
    	No VM guests are running outdated hypervisor (qemu) binaries on this host.
    	/nfs4-share     <world>(sync,wdelay,hide,no_subtree_check,sec=sys,rw,secure,no_root_squash,no_all_squash)
    	>>>> K8S Controlplane Config End <<<<
    	Cloud-init v. 22.1-14-g2e17a0d6-0ubuntu1~22.04.5 finished at Sun, 22 May 2022 12:24:19 +0000. Datasource DataSourceEc2Local.  Up 181.88 seconds
    ```
    
3. CNI/StorageClass ë“± ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
    - Control Plane SSH ì¢…ë£Œ í›„ ë‹¤ì‹œ SSH ì ‘ì†
    
    ```java
    (ğŸ |kubernetes-admin@kubernetes:default) root@k8s-m:~# exa -bghHliSR DOIK/
    	 inode Permissions Links Size Blocks User Group Date Modified Name
    	516217 drwxr-xr-x      2    -      - root root  22 May 21:23  1
    	516239 .rw-r--r--      1   55      8 root root  22 May 21:23  README.md
    	
    	DOIK/1:
    	 inode Permissions Links  Size Blocks User Group Date Modified Name
    	516232 .rw-r--r--      1   782      8 root root  22 May 21:23  1-3pods.yaml
    	516233 .rw-r--r--      1 213Ki    432 root root  22 May 21:23  calico-crosssubnet-v3.22.2.yaml
    	516234 .rwx------      1 1.2Ki      8 root root  22 May 21:23  final.sh
    	516235 .rwx------      1 2.3Ki      8 root root  22 May 21:23  init.sh
    	516236 .rwx------      1 1.9Ki      8 root root  22 May 21:23  master.sh
    	516237 .rw-r--r--      1 4.1Ki     16 root root  22 May 21:23  metrics-server.yaml
    	516238 .rwx------      1   971      8 root root  22 May 21:23  worker.sh
    (ğŸ |kubernetes-admin@kubernetes:default) root@k8s-m:~# cd /root/DOIK/1 && ./final.sh && cd $HOME
    	+ echo '[TASK 10] Install Calico CNI'
    	[TASK 10] Install Calico CNI
    	+ kubectl apply -f https://raw.githubusercontent.com/gasida/DOIK/main/1/calico-crosssubnet-v3.22.2.yaml
    	//...ì¤‘ëµ...
    	NAME: nfs-provisioner
    	LAST DEPLOYED: Mon May 23 01:09:44 2022
    	NAMESPACE: kube-system
    	STATUS: deployed
    	REVISION: 1
    	TEST SUITE: None
    ```
    

### (2) ì„¤ì¹˜ í™•ì¸ ì‘ì—…

1. cluster ë° node ì •ë³´ í™•ì¸
    
    ```java
    (ğŸ |kubernetes-admin@kubernetes:default) root@k8s-m:~# kubectl cluster-info
    	Kubernetes control plane is running at https://192.168.10.10:6443
    	CoreDNS is running at https://192.168.10.10:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
    	
    	To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
    (ğŸ |kubernetes-admin@kubernetes:default) root@k8s-m:~# kubectl get nodes -o wide
    	NAME     STATUS     ROLES                  AGE     VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE           KERNEL-VERSION    CONTAINER-RUNTIME
    	k8s-m    NotReady   control-plane,master   3h40m   v1.23.6   192.168.10.10    <none>        Ubuntu 22.04 LTS   5.15.0-1005-aws   docker://20.10.16
    	k8s-w1   NotReady   <none>                 3h39m   v1.23.6   192.168.10.101   <none>        Ubuntu 22.04 LTS   5.15.0-1005-aws   docker://20.10.16
    	k8s-w2   NotReady   <none>                 3h39m   v1.23.6   192.168.10.102   <none>        Ubuntu 22.04 LTS   5.15.0-1005-aws   docker://20.10.16
    	k8s-w3   NotReady   <none>                 3h39m   v1.23.6   192.168.20.103   <none>        Ubuntu 22.04 LTS   5.15.0-1005-aws   docker://20.10.16
    (ğŸ |DOIK-Lab:default) root@k8s-m:~# systemctl status kubelet
    	â— kubelet.service - kubelet: The Kubernetes Node Agent
    	     Loaded: loaded (/lib/systemd/system/kubelet.service; enabled; vendor preset: enabled)
    	    Drop-In: /etc/systemd/system/kubelet.service.d
    	             â””â”€10-kubeadm.conf
    	     Active: active (running) since Sun 2022-05-22 21:24:01 KST; 3h 50min ago
    	       Docs: https://kubernetes.io/docs/home/
    	   Main PID: 6426 (kubelet)
    	      Tasks: 16 (limit: 4623)
    	     Memory: 39.5M
    	        CPU: 4min 17.733s
    	     CGroup: /system.slice/kubelet.service
    	             â””â”€6426 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.co>
    	May 23 01:09:55 k8s-m kubelet[6426]: E0523 01:09:55.691582    6426 plugins.go:752] "Error dynamically probing plugins" err="error creating>May 23 01:09:55 k8s-m kubelet[6426]: E0523 01:09:55.691782    6426 driver-call.go:262] Failed to unmarshal output for command: init, outpu>May 23 01:09:55 k8s-m kubelet[6426]: W0523 01:09:55.691796    6426 driver-call.go:149] FlexVolume: driver call failed: executable: /usr/li>May 23 01:09:55 k8s-m kubelet[6426]: E0523 01:09:55.691812    6426 plugins.go:752] "Error dynamically probing plugins" err="error creating>May 23 01:09:55 k8s-m kubelet[6426]: E0523 01:09:55.692032    6426 driver-call.go:262] Failed to unmarshal output for command: init, outpu>May 23 01:09:55 k8s-m kubelet[6426]: W0523 01:09:55.692048    6426 driver-call.go:149] FlexVolume: driver call failed: executable: /usr/li>May 23 01:09:55 k8s-m kubelet[6426]: E0523 01:09:55.692065    6426 plugins.go:752] "Error dynamically probing plugins" err="error creating>May 23 01:09:55 k8s-m kubelet[6426]: E0523 01:09:55.692552    6426 driver-call.go:262] Failed to unmarshal output for command: init, outpu>May 23 01:09:55 k8s-m kubelet[6426]: W0523 01:09:55.692563    6426 driver-call.go:149] FlexVolume: driver call failed: executable: /usr/li>May 23 01:09:55 k8s-m kubelet[6426]: E0523 01:09:55.692581    6426 plugins.go:752] "Error dynamically probing plugins" err="error creating>lines 1-23/23 (END)
    (ğŸ |DOIK-Lab:default) root@k8s-m:~# kubectl get node -v7
    	I0523 01:15:39.343489   54205 loader.go:372] Config loaded from file:  /root/.kube/config
    	I0523 01:15:39.350372   54205 round_trippers.go:463] GET https://192.168.10.10:6443/api/v1/nodes?limit=500
    	I0523 01:15:39.350496   54205 round_trippers.go:469] Request Headers:
    	I0523 01:15:39.350513   54205 round_trippers.go:473]     Accept: application/json;as=Table;v=v1;g=meta.k8s.io,application/json;as=Table;v=v1beta1;g=meta.k8s.io,application/json
    	I0523 01:15:39.350612   54205 round_trippers.go:473]     User-Agent: kubectl/v1.23.6 (linux/amd64) kubernetes/ad33385
    	I0523 01:15:39.358562   54205 round_trippers.go:574] Response Status: 200 OK in 7 milliseconds
    	NAME     STATUS   ROLES                  AGE     VERSION
    	k8s-m    Ready    control-plane,master   3h51m   v1.23.6
    	k8s-w1   Ready    <none>                 3h51m   v1.23.6
    	k8s-w2   Ready    <none>                 3h51m   v1.23.6
    	k8s-w3   Ready    <none>                 3h51m   v1.23.6
    ```
        
2. kube-systemì— ì„¤ì¹˜ëœ components í™•ì¸
    
    ```java
    (ğŸ |DOIK-Lab:default) root@k8s-m:~# kubectl get pod -A
    	NAMESPACE            NAME                                                              READY   STATUS    RESTARTS   AGE
    	kube-system          calico-kube-controllers-7c845d499-v5qfh                           1/1     Running   0          6m52s
    	kube-system          calico-node-cpwhx                                                 1/1     Running   0          6m52s
    	kube-system          calico-node-njvrx                                                 1/1     Running   0          6m52s
    	kube-system          calico-node-sn7tg                                                 1/1     Running   0          6m52s
    	kube-system          calico-node-x4r8b                                                 1/1     Running   0          6m52s
    	kube-system          coredns-64897985d-856gx                                           1/1     Running   0          3h52m
    	kube-system          coredns-64897985d-m7l58                                           1/1     Running   0          3h52m
    	kube-system          etcd-k8s-m                                                        1/1     Running   0          3h52m
    	kube-system          kube-apiserver-k8s-m                                              1/1     Running   0          3h52m
    	kube-system          kube-controller-manager-k8s-m                                     1/1     Running   0          3h52m
    	kube-system          kube-proxy-dvcnf                                                  1/1     Running   0          3h52m
    	kube-system          kube-proxy-gxb6c                                                  1/1     Running   0          3h52m
    	kube-system          kube-proxy-ts8ht                                                  1/1     Running   0          3h52m
    	kube-system          kube-proxy-x6kkd                                                  1/1     Running   0          3h52m
    	kube-system          kube-scheduler-k8s-m                                              1/1     Running   0          3h52m
    	kube-system          metrics-server-6c8bfb487b-r8zs2                                   1/1     Running   0          6m44s
    	kube-system          nfs-provisioner-nfs-subdir-external-provisioner-7d9776885d5b7h5   1/1     Running   0          6m38s
    	local-path-storage   local-path-provisioner-dbd774c5c-tjfnh                            1/1     Running   0          6m44s
    ```


# 3. ì°¸ê³  ìë£Œ

- ğŸš€**ê°€ì‹œë‹¤ë‹˜ ë…¸ì…˜**ğŸš€