---
published: true
layout: single
title: "[DevOps/Terraform/T101] í…Œë¼í¼ìœ¼ë¡œ AWS EKS ìƒì„±í•˜ê³  Kubernetes ë¦¬ì†ŒìŠ¤ ê´€ë¦¬í•˜ê¸°"
excerpt: "T101 í…Œë¼í¼ ìŠ¤í„°ë”” ì¡¸ì—…ê³¼ì œ - Provider AWS & Kuberenetes ì‚¬ìš©"
categories: DevOps
tag: [Kubernetes, Terraform]
toc: true
author_profile: false
sidebar:
    nav: "docs"
---

ì´ë²ˆì—ëŠ” terraformìœ¼ë¡œ EKS í´ëŸ¬ìŠ¤í„°ë¥¼ ìƒì„±í•´ ë³´ê³  *(íŠœí† ë¦¬ì–¼ëŒ€ë¡œë§Œ)*

terraformìœ¼ë¡œ kubernetes ë¦¬ì†ŒìŠ¤ ê´€ë¦¬ê¹Œì§€ í•´ ë³¼ ê²ƒì´ë‹¤!

# Provision an EKS Cluster (AWS)

[*ì°¸ê³  ë§í¬ ) Provision an EKS Cluster (AWS) - Terraform - HashiCorp Developer*](https://developer.hashicorp.com/terraform/tutorials/kubernetes/eks)

hashicorp ì‚¬ì—ì„œ ì œê³µí•˜ëŠ” íŠœí† ë¦¬ì–¼ì„ ë”°ë¼ EKS í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì¶•í•´ ë³´ì•˜ë‹¤.

íŠœí† ë¦¬ì–¼ëŒ€ë¡œ ë”°ë¼í•˜ë©´ ë§‰í˜ì—†ì´ ì˜ êµ¬ì¶•í•  ìˆ˜ ìˆëŠ”ë° í•„ìš”ì— ë”°ë¼ tf íŒŒì¼ì„ ìˆ˜ì •í•´ ì£¼ë©´ ëœë‹¤.

```bash
$ git clone https://github.com/hashicorp/learn-terraform-provision-eks-cluster
$ cd learn-terraform-provision-eks-cluster
$ ls -al
	total 61
	drwxr-xr-x 1 rkdls 197609     0 Dec  7 20:39 ./
	drwxr-xr-x 1 rkdls 197609     0 Dec  7 20:39 ../
	drwxr-xr-x 1 rkdls 197609     0 Dec  7 20:39 .git/
	-rw-r--r-- 1 rkdls 197609   674 Dec  7 20:39 .gitignore
	-rw-r--r-- 1 rkdls 197609  5772 Dec  7 20:39 .terraform.lock.hcl
	-rw-r--r-- 1 rkdls 197609 17136 Dec  7 20:39 LICENSE
	-rw-r--r-- 1 rkdls 197609   269 Dec  7 20:39 README.md
	-rw-r--r-- 1 rkdls 197609  1160 Dec  7 20:39 eks-cluster.tf
	-rw-r--r-- 1 rkdls 197609  1095 Dec  7 20:39 main.tf
	-rw-r--r-- 1 rkdls 197609   592 Dec  7 20:39 outputs.tf
	-rw-r--r-- 1 rkdls 197609   518 Dec  7 20:39 security-groups.tf
	-rw-r--r-- 1 rkdls 197609   527 Dec  7 20:39 terraform.tf
	-rw-r--r-- 1 rkdls 197609   107 Dec  7 20:39 variables.tf
	-rw-r--r-- 1 rkdls 197609   739 Dec  7 20:39 vpc.tf
```

`eks-cluster.tf`ì€ í´ëŸ¬ìŠ¤í„°ë¥¼ ìƒì„±í•˜ê³  ë…¸ë“œ ê·¸ë£¹ì„ êµ¬ì„±í•  ìˆ˜ ìˆë‹¤.

`main.tf`ì— ì§€ì •í•´ ë‘” í´ëŸ¬ìŠ¤í„° ì´ë¦„ì„ ì‚¬ìš©í•˜ê³  `vpc.tf`ì™€ `security-groups.tf`ë¡œ ìƒì„±í•œ í™˜ê²½ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤

ë…¸ë“œ ê·¸ë£¹ë§ˆë‹¤ ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…ì„ ì§€ì •í•  ìˆ˜ ìˆê³  ë””í´íŠ¸ë¡œ ì˜¨ë””ë§¨ë“œ ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±ëœë‹¤.

min/max/desired sizeë¡œ ê° ë…¸ë“œ ê·¸ë£¹ë§ˆë‹¤ ì›í•˜ëŠ” ë…¸ë“œ ìˆ˜ë¥¼ ì§€ì •í•  ìˆ˜ ìˆë‹¤

```bash
module "eks" {
  source  = "terraform-aws-modules/eks/aws"
  version = "18.26.6"

  cluster_name    = local.cluster_name     # main.tf
  cluster_version = "1.22"

  vpc_id     = module.vpc.vpc_id    # vpc.tf
  subnet_ids = module.vpc.private_subnets    # vpc.tf

  eks_managed_node_group_defaults = {
    ami_type = "AL2_x86_64"

    attach_cluster_primary_security_group = true

    # Disabling and using externally provided security groups
    create_security_group = false
  }

  eks_managed_node_groups = {
    one = {
      name = "node-group-1"

      instance_types = ["t3.small"]

      min_size     = 1
      max_size     = 3
      desired_size = 2

      pre_bootstrap_user_data = <<-EOT
      echo 'foo bar'
      EOT

      vpc_security_group_ids = [
        aws_security_group.node_group_one.id    # security-groups.tf
      ]
    }

    two = {
      name = "node-group-2"

      instance_types = ["t3.medium"]

      min_size     = 1
      max_size     = 2
      desired_size = 1

      pre_bootstrap_user_data = <<-EOT
      echo 'foo bar'
      EOT

      vpc_security_group_ids = [
        aws_security_group.node_group_two.id    # security-groups.tf
      ]
    }
  }
}
```

![Untitled](Terraform%20-%20EKS%20ac736aae18dd4504a5b5e112675cb7f6/Untitled.png)

ë§ˆì§€ë§‰ìœ¼ë¡œ `variables.tf`ì—ì„œ regionë§Œ ì„œìš¸ ë¦¬ì „ìœ¼ë¡œ ìˆ˜ì •í•´ ì¤¬ë‹¤.

ì´ì œ terraform ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•´ ì£¼ë©´ EKS êµ¬ì¶• ì„±ê³µì´ë‹¤!

```bash
$ terraform init
$ terraform apply -auto-approve
```

ë§ˆì§€ë§‰ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„°ì— ì ‘ì†í•˜ê¸° ìœ„í•´ aws configureì— ë“±ë¡ëœ IAM ìœ ì €ì— ëŒ€í•´ì„œ í† í°ì„ ë°œê¸‰í•˜ì—¬ ì‚¬ìš©í•˜ë„ë¡ í•˜ëŠ” kubeconfigë¥¼ ìƒì„±í•˜ë©´ ëœë‹¹

```bash
$ aws eks --region $(terraform output -raw region) update-kubeconfig \
--name $(terraform output -raw cluster_name)
	Added new context arn:aws:eks:ap-northeast-2:[account-id]:cluster/education-eks-woK1xAos to /home/gain/.kube/config
$ cat /home/gain/.kube/config
	apiVersion: v1
	clusters:
	- cluster:
	    certificate-authority-data: [token]
	    server: https://[control-plane].gr7.ap-northeast-2.eks.amazonaws.com
	  name: arn:aws:eks:ap-northeast-2:[account-id]:cluster/education-eks-woK1xAos
	contexts:
	- context:
	    cluster: arn:aws:eks:ap-northeast-2:[account-id]:cluster/education-eks-woK1xAos
	    user: arn:aws:eks:ap-northeast-2:[account-id]:cluster/education-eks-woK1xAos
	  name: arn:aws:eks:ap-northeast-2:[account-id]:cluster/education-eks-woK1xAos
	current-context: arn:aws:eks:ap-northeast-2:[account-id]:cluster/education-eks-woK1xAos
	kind: Config
	preferences: {}
	users:
	- name: arn:aws:eks:ap-northeast-2:[account-id]:cluster/education-eks-woK1xAos
	  user:
	    exec:
	      apiVersion: client.authentication.k8s.io/v1beta1
	      args:
	      - --region
	      - ap-northeast-2
	      - eks
	      - get-token
	      - --cluster-name
	      - education-eks-woK1xAos
	      command: aws
```

ì´ì œ ìƒì„±ëœ í´ëŸ¬ìŠ¤í„° ì •ë³´ì™€ nodeë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤!

```bash
$ kubectl cluster-info
	Kubernetes control plane is running at https://[control-plane].gr7.ap-northeast-2.eks.amazonaws.com
	CoreDNS is running at https://[control-plane].gr7.ap-northeast-2.eks.amazonaws.com/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
	
	To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
$ kubectl get nodes
	NAME                                           STATUS   ROLES    AGE    VERSION
	ip-10-0-2-41.ap-northeast-2.compute.internal   Ready    <none>   158m   v1.22.15-eks-fb459a0
	ip-10-0-2-7.ap-northeast-2.compute.internal    Ready    <none>   158m   v1.22.15-eks-fb459a0
	ip-10-0-3-12.ap-northeast-2.compute.internal   Ready    <none>   158m   v1.22.15-eks-fb459a0
```

![Untitled](Terraform%20-%20EKS%20ac736aae18dd4504a5b5e112675cb7f6/Untitled%201.png)

# AWS EKS ìƒì„± í›„,

EKSë¥¼ ìƒì„±í•˜ê³  ë‚˜ì„œ ì„¤ì¹˜í•´ì•¼ í•˜ëŠ” í•„ìˆ˜ ë¦¬ì†ŒìŠ¤ëŠ” ì•„ë˜ì™€ ê°™ì€ë° ë‚˜ëŠ” deployment í•˜ë‚˜ë§Œ ìƒì„±í•˜ì˜€ë‹¤.

ì™œëƒí•˜ë©´ EKS ìƒì„±í•˜ê³  ë‚˜ì„œ ì–´ë–»ê²Œ terraformìœ¼ë¡œ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬ë¥¼ í•˜ëŠ”ì§€ê°€ ì´ë²ˆ í¬ìŠ¤íŒ…ì˜ ëª©ì ì´ê¸° ë•Œë¬¸ì— ë‚˜ë¨¸ì§€ëŠ” ìƒëµí•˜ì˜€ë‹¤! (ì¿ ë²„ë„¤í‹°ìŠ¤ ì‚¬ìš©ì´ ì•„ë‹ˆë¼ í…Œë¼í¼ ì‚¬ìš©ì´ ì£¼ ëª©ì !!!!)

- **[cluster-autoscaler](https://docs.aws.amazon.com/eks/latest/userguide/autoscaling.html#cluster-autoscaler)**  
    cluster autoscalerëŠ” pod ìƒíƒœê°€ failì´ê±°ë‚˜ ë‹¤ë¥¸ ë…¸ë“œë¡œ rescheduledë˜ëŠ” ê²½ìš°ì— í´ëŸ¬ìŠ¤í„°ì˜ ë…¸ë“œ ìˆ˜ë¥¼ autoscalingí•´ ì¤€ë‹¤. ì¼ë°˜ì ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„°ì— ë°°í¬ëœë‹¤.
- **[aws-node-termination-handler (NTH)](https://aws.amazon.com/ko/about-aws/whats-new/2019/11/aws-supports-automated-draining-for-spot-instance-nodes-on-kubernetes/)** *(ìŠ¤íŒŸ ì¸ìŠ¤í„´ìŠ¤ ì‚¬ìš© ì‹œ í•„ìˆ˜ì¸ë“¯í•¨)*  
    AWSì—ì„œëŠ” ë¯¸ì‚¬ìš© EC2 ìš©ëŸ‰ì„ í™œìš©í•˜ë©´ì„œ ë¹„ìš© ì ˆê°ì„ í•˜ê¸° ìœ„í•´ EC2 ìŠ¤íŒŸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê¸°ë„ í•œë‹¤ëŠ”ë°, ìŠ¤íŒŸ ì¸ìŠ¤í„´ìŠ¤ ì¢…ë£Œ ì•ŒëŒì´ ë°œìƒí•˜ê³  ë‚˜ë©´ ì¸ìŠ¤í„´ìŠ¤ëŠ” 2ë¶„ í›„ì— íšŒìˆ˜ëœë‹¤. aws-node-termination-handlerê°€ ì¸í„°ëŸ½ì…˜ì„ ì²´í¬í•˜ë‹¤ê°€ nodeì— ìˆëŠ” podë¥¼ drainí•˜ê³ , nodeê°€ íšŒìˆ˜ë˜ë©´ ìµœëŒ€í•œ ì•ˆì „í•˜ê²Œ ë‹¤ë¥¸ nodeì— podë¥¼ bindingí•˜ëŠ” ì—­í• ì„ í•œë‹¤.
- **metrics-server**  
    í´ëŸ¬ìŠ¤í„° ì „ì²´ì˜ ë¦¬ì†ŒìŠ¤ ì‚¬ìš© ë°ì´í„°ë¥¼ ëª¨ë‹ˆí„°ë§í•˜ëŠ”ë°, ë…¸ë“œë‚˜ ì»¨í…Œì´ë„ˆì˜ cpu ë° memory ê°™ì€ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•  ìˆ˜ ìˆë‹¤.
- **ingress controller**  
    ì™¸ë¶€ íŠ¸ë˜í”½ì— ëŒ€í•œ ê·œì¹™ì„ ì •ì˜í•´ ë‘” ingress ë¦¬ì†ŒìŠ¤ì— ë”°ë¼ L7 ë¡œë“œë°¸ëŸ°ì„œë¥¼ êµ¬ì„±í•˜ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ì´ë‹¤.
    

[ì°¸ê³  ë§í¬ ) k8s í•„ìˆ˜ ì• í”Œë¦¬ì¼€ì´ì…˜, í…Œë¼í¼ìœ¼ë¡œ í•œë²ˆì— ì„¤ì¹˜í•˜ê¸°](https://subicura.com/k8s/2020/12/18/eks-terraform-setup/)

# â˜… Manage Kubernetes Resources via Terraform

ì•„ë˜ ë§í¬ë¥¼ ì°¸ì¡°í•˜ì—¬ ì‹¤ìŠµì„ ì§„í–‰í•´ ë³´ì•˜ê³  ì •ë§ ê°„ë‹¨í•˜ì§€ë§Œ ë‚´ [GitHub Repo](https://github.com/gain-yoo/learn-terraform-deploy-nginx-kubernetes)ì— ì˜¬ë ¤ë‘ì—ˆë‹¤ã…ã…



[ì°¸ê³  ë§í¬ ) Manage Kubernetes Resources via Terraform - Terraform - HashiCorp Developer](https://developer.hashicorp.com/terraform/tutorials/kubernetes/kubernetes-provider)

## 1. Provider Kubernetes ì„¤ì •

`kubernetes.tf` íŒŒì¼ì—ì„œ ìš°ì„  providerë¥¼ ì§€ì •í•´ ì¤€ë‹¤.

```bash
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = ">= 3.20.0"
    }

    kubernetes = {
      source  = "hashicorp/kubernetes"
      version = ">= 2.0.1"
    }
  }
}
```

ê·¸ë¦¬ê³  â€œlearn-terraform-provision-eks-clusterâ€ë¡œ ë°°í¬í•œ EKS í´ëŸ¬ìŠ¤í„° ì •ë³´ëŠ” **tfstate íŒŒì¼**ì— ì €ì¥ë˜ì–´ ìˆëŠ” ì ì„ í™œìš©í•˜ì—¬ EKS í´ëŸ¬ìŠ¤í„°ì— ì ‘ê·¼í•  ê²ƒì´ë‹¤.

```bash
data "terraform_remote_state" "eks" {
  backend = "local"

  config = {
    path = "../learn-terraform-provision-eks-cluster/terraform.tfstate"
  }
}

# Retrieve EKS cluster information
provider "aws" {
  region = data.terraform_remote_state.eks.outputs.region
}

data "aws_eks_cluster" "cluster" {
  name = data.terraform_remote_state.eks.outputs.cluster_id
}
```

ê·¸ë¦¬ê³  kubernetesë¥¼ providerë¡œ êµ¬ì„±í•˜ë ¤ë©´ ì—¬ëŸ¬ ê°€ì§€ ë°©ë²•ì´ ìˆì§€ë§Œ ì•„ë˜ì™€ ê°™ì´ í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.

```bash
provider "kubernetes" {
  host                   = data.aws_eks_cluster.cluster.endpoint
  cluster_ca_certificate = base64decode(data.aws_eks_cluster.cluster.certificate_authority.0.data)
  exec {
    api_version = "client.authentication.k8s.io/v1alpha1"
    command     = "aws"
    args = [
      "eks",
      "get-token",
      "--cluster-name",
      data.aws_eks_cluster.cluster.name
    ]
  }
}
```

ì™œëƒí•˜ë©´ AWS EKSì—ì„œëŠ” 15ë¶„ í›„ì— ì¸ì¦ í† í°ì´ ë§Œë£Œë˜ê¸° ë•Œë¬¸ì—, EKSì—ì„œ ì œê³µí•˜ëŠ” ì¸ì¦ í”ŒëŸ¬ê·¸ì¸(`eks get-token`)ì„ ì‚¬ìš©í•˜ì—¬ í† í°ì´ í•­ìƒ ìµœì‹ ì¸ì§€ í™•ì¸í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤!

ë‹¤ë¥¸ ë°©ë²•ì€ oauth2 token ì‚¬ìš©, TLS ì¸ì¦ì„œ ìê²© ì¦ëª… ì‚¬ìš©, HTTP ê¸°ë³¸ ì¸ì¦ ë“±ì´ ìˆë‹¤ê³  í•œë‹¤.

ê¶ê¸ˆí•˜ë‹¤ë©´ [Terraform Registry](https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/guides/getting-started#provider-setup)ì—ì„œ ì°¾ì•„ ë³´ì~

## 2. Deployment ë¦¬ì†ŒìŠ¤ ìƒì„±

terraformìœ¼ë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±í•  ë•Œë„ yaml íŒŒì¼ë¡œ êµ¬ì„±í•˜ëŠ” ê²ƒê³¼ ë³„ë°˜ ë‹¤ë¥´ì§€ ì•Šì•˜ë‹¤.

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment-nginx
spec:
  selector:
    matchLabels:
      app: ScalableNginx
  replicas: 2 # tells deployment to run 2 pods matching the template
  template:
    metadata:
      labels:
        app: ScalableNginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.7.8
        ports:
        - containerPort: 80
				resources:
		      requests:
		        memory: "50Mi"
		        cpu: "250m"
		      limits:
		        memory: "512Mi"
		        cpu: "0.5"
```

ê¸°ì¡´ ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œ ì‚¬ìš©í•˜ëŠ” yaml êµ¬ì„±íŒŒì¼ì¸ë° tf íŒŒì¼ë¡œ ì•„ë˜ì™€ ê°™ì´ ë°”ê¿€ ìˆ˜ ìˆë‹¤.

```bash
resource "kubernetes_deployment" "nginx" {
  metadata {
    name = "deployment-nginx"
    labels = {
      App = "ScalableNginx"
    }
  }

  spec {
    replicas = 2
    selector {
      match_labels = {
        App = "ScalableNginx"
      }
    }
    template {
      metadata {
        labels = {
          App = "ScalableNginx"
        }
      }
      spec {
        container {
          image = "nginx:1.7.8"
          name  = "nginx"

          port {
            container_port = 80
          }

          resources {
            limits = {
              cpu    = "0.5"
              memory = "512Mi"
            }
            requests = {
              cpu    = "250m"
              memory = "50Mi"
            }
          }
        }
      }
    }
  }
}
```

ì•„ë˜ì™€ ê°™ì´ terraform applyë¥¼ í•´ ì£¼ë©´ ë¦¬ì†ŒìŠ¤ ìƒì„± ì™„ë£Œë‹¤!

```bash
$ terraform apply -auto-approve
	data.terraform_remote_state.eks: Reading...
	data.terraform_remote_state.eks: Read complete after 0s
	data.aws_eks_cluster.cluster: Reading...
	data.aws_eks_cluster.cluster: Read complete after 0s [id=education-eks-woK1xAos]
	
	...(ì¤‘ëµ)...
	
	Plan: 1 to add, 0 to change, 0 to destroy.
	kubernetes_deployment.nginx: Creating...
	kubernetes_deployment.nginx: Creation complete after 5s [id=default/ingress-nginx]
	
	Apply complete! Resources: 1 added, 0 changed, 0 destroyed.
```

![Untitled](Terraform%20-%20EKS%20ac736aae18dd4504a5b5e112675cb7f6/Untitled%202.png)

í—‰ ì™„ì „ ì‹ ê¸°â€¦..

ì§„ì§œ deployment-nginxê°€ ìƒê²¼ë‹¤!!!

# ì‚­ì œë„ ë©€-ë”í•œ Terraform ì‚¬ìš©!

```yaml
$ terraform destroy -auto-approve
```

ì´ ëª…ë ¹ì–´ë§Œ ì³ì£¼ë©´ ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤ë„, EKS í´ëŸ¬ìŠ¤í„°ë„, ë©€-ë”í•˜ê²Œ ì‚­ì œ ê°€ëŠ¥í•˜ë‹¤! ğŸ‘