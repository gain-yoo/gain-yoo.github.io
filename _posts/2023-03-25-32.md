---
published: true
layout: single
title: "[Kubernetes/PKOS2] ì•½ê°„ì˜ kops ì„¤ëª…ê³¼ lens ì ‘ì†"
excerpt: "kopsë¡œ awsì— k8s êµ¬ì¶•í•˜ê³  lensë¡œ ì ‘ì†í•˜ê¸°"
categories: Kubernetes
tag: [Kubernetes, kops, kubeconfig, lens]
toc: true
author_profile: false
sidebar:
    nav: "docs"
---

ê°€ì‹œë‹¤ë‹˜ì˜ ìŠ¤í„°ë”” PKOS(Production Kubernetes Online Study)ë¥¼ ì‹œì‘í•˜ê²Œ ë˜ì—ˆë‹¤!

PKOS ìŠ¤í„°ë””ëŠ”  â€˜[24ë‹¨ê³„ ì‹¤ìŠµìœ¼ë¡œ ì •ë³µí•˜ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤](http://www.yes24.com/Product/Goods/115187666)â€™ ì±… ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì§„í–‰ëœë‹¤ ğŸ˜Š

![Untitled](https://user-images.githubusercontent.com/100563973/227705553-eed8de50-be59-49f7-a13a-74cf818fc497.png)


ë³¸ ìŠ¤í„°ë””ëŠ” kops (**K**ubernetes **Op**eration**s)** ë„êµ¬ë¥¼ í†µí•´ AWSì—ì„œ k8s í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì¶•, ê´€ë¦¬, ìš´ì˜í•˜ê²Œ ëœë‹¤

# k8s í”„ë¡œë¹„ì €ë‹ ë„êµ¬

í´ëŸ¬ìŠ¤í„° í”„ë¡œë¹„ì €ë‹ ë„êµ¬ë¡œëŠ” Kops, Kubespray, Kubeadm, Minikube ë“±ì´ ìˆëŠ”ë° ê°ê°ì˜ ì¥ë‹¨ì ì´ ë‹¬ë¼ì„œ ìì‹ ì˜ ìœ ìŠ¤ì¼€ì´ìŠ¤ì— ë”°ë¼ ë„êµ¬ë¥¼ ì„ íƒí•˜ë©´ ëœë‹¤.

|  | Kops | Kubespray  | Kubeadm | Minikube |
| --- | --- | --- | --- | --- |
| ? | AWS ìµœì í™” | Ansible ê¸°ë°˜, ë©€í‹°í´ë¼ìš°ë“œ ì§€ì› | kubernetesì—ì„œ ì œê³µí•˜ëŠ” ê¸°ë³¸ì ì¸ ë„êµ¬ | ë¡œì»¬ ê°œë°œ ë° í…ŒìŠ¤íŠ¸ìš© |
| node | ë©€í‹°ë…¸ë“œ | ë©€í‹°ë…¸ë“œ | ë©€í‹°ë…¸ë“œ | ë‹¨ì¼ë…¸ë“œ |
| setup | [kops](https://kubernetes.io/ko/docs/setup/production-environment/tools/kops/) | [kubespary](https://kubernetes.io/ko/docs/setup/production-environment/tools/kubespray/) | [kubeadm](https://kubernetes.io/ko/docs/setup/production-environment/tools/kubeadm/install-kubeadm/) | [minikube](https://kubernetes.io/ko/docs/tutorials/hello-minikube/) |

**kops**ì™€ **kubespary**ëŠ” ìš´ì˜ ì°¨ì›ì—ì„œ ê°„í¸í•˜ê²Œ í´ëŸ¬ìŠ¤í„°ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” ìë™í™” ë„êµ¬ì´ê³ ,

**kubeadm**ì€ í´ëŸ¬ìŠ¤í„°ë¥¼ ë¶€íŠ¸ìŠ¤íŠ¸ë©í•˜ëŠ” ë„êµ¬ë¡œ í´ëŸ¬ìŠ¤í„° êµ¬ì¶•í•  ë•Œ ê°„í¸í•˜ì§€ëŠ” ì•Šë‹¤.

**minikube**ëŠ” ë§ê·¸ëŒ€ë¡œ í…ŒìŠ¤íŠ¸ ìš©ë„ë¡œë§Œ ì í•©í•˜ë‹¤.

# kopsë¡œ awsì—ì„œ k8s í´ëŸ¬ìŠ¤í„° êµ¬ì¶•

![Untitled 1](https://user-images.githubusercontent.com/100563973/227705564-2f003cc7-03e1-424a-bd90-aadaac3faf1d.png)


*ê·¸ë¦¼ ì¶œì²˜ ) ê°€ì‹œë‹¤ë‹˜ ë…¸ì…˜ ì œê³µ*

ìœ„ ì‹¤ìŠµ êµ¬ì„±ë„ëŒ€ë¡œ í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì¶•í–ˆë‹¤

- `kops-ec2` : ë°°ìŠ¤ì²œ ì„œë²„ë¡œ, kopsë¥¼ ì„¤ì¹˜í•˜ì—¬ í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì¶•í•˜ê³  kubectl ëª…ë ¹ì„ ìˆ˜í–‰
- `s3` : k8s ì„¤ì • íŒŒì¼ ì €ì¥
- ë²„ì „ : k8s v1.24.10, OS Ubuntu 20.04 LTS
- Control Planeê³¼ NodeëŠ” EC2 Auto Scaling Group(=ASG) ì„¤ì •ìœ¼ë¡œ êµ¬ì„±
- í¼ë¸”ë¦­ ë„ë©”ì¸ êµ¬ë§¤í•˜ì—¬ ì‚¬ìš©

## ìƒì„±ëœ kubeconfigë¡œ lens ì ‘ì†

kopsë¡œ í´ëŸ¬ìŠ¤í„° êµ¬ì¶•í•˜ëŠ” ê³¼ì •ì€ ìƒëµí•˜ê² ë‹¤â€¦(ã…ã…)

kopsë¡œ í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì¶•í•˜ë©´ì„œ kubeconfigëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆë‹¤

```bash
[root@kops-ec2 ~]# cat ~/.kube/config
	apiVersion: v1
	clusters:
	- cluster:
	    certificate-authority-data: [certificate-authority-data]
	    server: https://api.yooga.in
	  name: yooga.in
	contexts:
	- context:
	    cluster: yooga.in
	    user: yooga.in
	  name: yooga.in
	current-context: yooga.in
	kind: Config
	preferences: {}
	users:
	- name: yooga.in
	  user:
	    client-certificate-data: [client-certificate-data]
	    client-key-data: [client-key-data]
```

ê·¸ë˜ì„œ ì´ kubeconfigë¡œ lens ì ‘ì†í•˜ë ¤ í•˜ë‹ˆ,, 

ë¶„ëª… í´ëŸ¬ìŠ¤í„°ë¥¼ êµ¬ì¶•í•œ ë‹¹ì‹œì—ëŠ” kops-ec2(ë°°ìŠ¤ì²œì„œë²„) â†’ k8s api serverë¡œ ì ‘ê·¼ì´ ëì—ˆëŠ”ë°,,,

kubeconfig ë‹¤ìš´ë°›ìœ¼ë ¤ë‹ˆ ê°‘ìê¸° ì•„ë˜ì™€ ê°™ì´ ê¶Œí•œì´ ì—†ë‹¤ëŠ” ì—ëŸ¬ë¥¼ ë±‰ëŠ”ë‹¤.

```bash
[root@kops-ec2 ~]# kubectl get nodes -v6
	I0325 16:08:13.665555   13638 loader.go:373] Config loaded from file:  /root/.kube/config
	I0325 16:08:13.740641   13638 round_trippers.go:553] GET https://api.yooga.in/api?timeout=32s 401 Unauthorized in 74 milliseconds
	E0325 16:08:13.740943   13638 memcache.go:265] couldn't get current server API group list: the server has asked for the client to provide credentials
	I0325 16:08:13.740960   13638 cached_discovery.go:120] skipped caching discovery info due to the server has asked for the client to provide credentials
	I0325 16:08:13.742184   13638 round_trippers.go:553] GET https://api.yooga.in/api?timeout=32s 401 Unauthorized in 1 milliseconds
	E0325 16:08:13.742397   13638 memcache.go:265] couldn't get current server API group list: the server has asked for the client to provide credentials
	I0325 16:08:13.742410   13638 cached_discovery.go:120] skipped caching discovery info due to the server has asked for the client to provide credentials
	I0325 16:08:13.742435   13638 shortcut.go:100] Error loading discovery information: the server has asked for the client to provide credentials
	I0325 16:08:13.743416   13638 round_trippers.go:553] GET https://api.yooga.in/api?timeout=32s 401 Unauthorized in 0 milliseconds
	E0325 16:08:13.743623   13638 memcache.go:265] couldn't get current server API group list: the server has asked for the client to provide credentials
	I0325 16:08:13.743635   13638 cached_discovery.go:120] skipped caching discovery info due to the server has asked for the client to provide credentials
	I0325 16:08:13.784823   13638 round_trippers.go:553] GET https://api.yooga.in/api?timeout=32s 401 Unauthorized in 41 milliseconds
	E0325 16:08:13.785080   13638 memcache.go:265] couldn't get current server API group list: the server has asked for the client to provide credentials
	I0325 16:08:13.785094   13638 cached_discovery.go:120] skipped caching discovery info due to the server has asked for the client to provide credentials
	I0325 16:08:13.786286   13638 round_trippers.go:553] GET https://api.yooga.in/api?timeout=32s 401 Unauthorized in 1 milliseconds
	E0325 16:08:13.786514   13638 memcache.go:265] couldn't get current server API group list: the server has asked for the client to provide credentials
	I0325 16:08:13.786527   13638 cached_discovery.go:120] skipped caching discovery info due to the server has asked for the client to provide credentials
	I0325 16:08:13.786667   13638 helpers.go:246] server response object: [{
	  "metadata": {},
	  "status": "Failure",
	  "message": "the server has asked for the client to provide credentials",
	  "reason": "Unauthorized",
	  "details": {
	    "causes": [
	      {
	        "reason": "UnexpectedServerResponse",
	        "message": "unknown"
	      }
	    ]
	  },
	  "code": 401
	}]
	error: You must be logged in to the server (the server has asked for the client to provide credentials)
```

(ì›ë˜ admin ê¶Œí•œì´ì—ˆì„ê±°ê°™ì§€ë§Œ) admin ê¶Œí•œìœ¼ë¡œ ë‹¤ì‹œ kubeconfigë¥¼ ìƒì„±í•˜ê³  í™•ì¸í•´ ë³´ë©´

[ì°¸ê³  ë¬¸ì„œ ) Kops export kubeconfig - kOps - Kubernetes Operations](https://kops.sigs.k8s.io/cli/kops_export_kubeconfig/)

```bash
[root@kops-ec2 ~]# kops export kubeconfig --name yooga.in --admin
	kOps has set your kubectl context to yooga.in
[root@kops-ec2 ~]# cat ~/.kube/config
	apiVersion: v1
	clusters:
	- cluster:
	    certificate-authority-data: [certificate-authority-data]
	    server: https://api.yooga.in
	  name: yooga.in
	contexts:
	- context:
	    cluster: yooga.in
	    user: yooga.in
	  name: yooga.in
	current-context: yooga.in
	kind: Config
	preferences: {}
	users:
	- name: yooga.in
	  user:
	    client-certificate-data: [client-certificate-data]
	    client-key-data: [client-key-data]
```

`users.user`ì—ì„œ `client-certificate-data`, `client-key-data` ì´ ë‘ ê°€ì§€ ê°’ì´ ë°”ë€Œì—ˆë‹¤.

ê·¸ë¦¬ê³  k8sì— ì ‘ê·¼ë„ ì˜ëœë‹¤.

```bash
[root@kops-ec2 ~]# kubectl cluster-info
	Kubernetes control plane is running at https://api.yooga.in
	CoreDNS is running at https://api.yooga.in/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
	
	To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'
```

ì´ì œ ì´ kubeconfigë¡œ lensì— ì ‘ì†! í›„í›„

![Untitled 2](https://user-images.githubusercontent.com/100563973/227705609-3c96a6df-7e3b-4f67-9c99-99bd7c4ee59a.png)

![Untitled 3](https://user-images.githubusercontent.com/100563973/227705597-d6c523ff-242c-4657-98f7-bbd034d357b5.png)

## +) kops export kubeconfig duration

kops export kubeconfigí•˜ë©´ ê¸°ë³¸ `18h`ë¡œ durationì´ ì¡í˜€ ìˆì–´ì„œ ê·¸ ì´í›„ì—” í¬ë ˆë´ì…œì´ ë§Œë£Œë˜ê³  `Unauthorized` ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤.

[ê³µì‹ ë¬¸ì„œ ì°¸ê³  ) Kops export kubeconfig - kOps - Kubernetes Operations](https://kops.sigs.k8s.io/cli/kops_export_kubeconfig/)

```bash
kops export kubecfg --admin=87600h
```

ì´ ë•Œ ìœ„ì™€ ê°™ì€ ê°’ì„ ë„£ì–´ì£¼ë©´ 10ë…„ì´ë‚˜ ë” ì“¸ ìˆ˜ ìˆë‹¤ ã…‹ã…‹

[ì°¸ê³  ) kops export kubeconfig with no diminishing TTL](https://stackoverflow.com/questions/66687176/kops-export-kubeconfig-with-no-diminishing-ttl)
